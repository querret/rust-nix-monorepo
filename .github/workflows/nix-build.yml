name: Nix Build and Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: cachix/install-nix-action@v26
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      
      - name: Build web-service
        run: nix build .#web-service --print-build-logs
      
      - name: Copy web-service binary
        run: |
          mkdir -p artifacts
          cp -L result/bin/web-service artifacts/web-service
          chmod +x artifacts/web-service
      
      - name: Build api-service
        run: nix build .#api-service --print-build-logs
      
      - name: Copy api-service binary
        run: |
          cp -L result/bin/api-service artifacts/api-service
          chmod +x artifacts/api-service
      
      - name: Build cli-tool
        run: nix build .#cli-tool --print-build-logs
      
      - name: Run tests
        run: nix develop --command cargo test
      
      # Upload built binaries as artifacts
      - name: Upload web-service binary
        uses: actions/upload-artifact@v4
        with:
          name: web-service
          path: artifacts/web-service
          retention-days: 7
      
      - name: Upload api-service binary
        uses: actions/upload-artifact@v4
        with:
          name: api-service
          path: artifacts/api-service
          retention-days: 7
      
      - name: Upload static files
        uses: actions/upload-artifact@v4
        with:
          name: static-files
          path: services/web-service/static/
          retention-days: 7

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      # Download pre-built binaries
      - name: Download web-service binary
        uses: actions/download-artifact@v4
        with:
          name: web-service
          path: ./binaries/

      - name: Download api-service binary
        uses: actions/download-artifact@v4
        with:
          name: api-service
          path: ./binaries/

      - name: Download static files
        uses: actions/download-artifact@v4
        with:
          name: static-files
          path: ./static/

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Write private key from GitHub Secret (tumbleweed.pem contents)
          printf '%s\n' "${{ secrets.AWS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Pre-populate known_hosts for strict host key checking
          ssh-keyscan -H "${{ secrets.AWS_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy web-service
        run: |
          chmod +x ./binaries/web-service

          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            ./binaries/web-service \
            ubuntu@${{ secrets.AWS_HOST }}:/tmp/web-service

          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            -r ./static \
            ubuntu@${{ secrets.AWS_HOST }}:/tmp/

          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            ubuntu@${{ secrets.AWS_HOST }} << 'EOF'
              sudo mv /tmp/web-service /usr/local/bin/web-service-monorepo
              sudo chmod +x /usr/local/bin/web-service-monorepo

              sudo mkdir -p /usr/local/share/web-service/static
              sudo cp -r /tmp/static/* /usr/local/share/web-service/static/
              sudo rm -rf /tmp/static

              sudo systemctl restart web-service-monorepo
            EOF

      - name: Deploy api-service
        run: |
          chmod +x ./binaries/api-service

          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            ./binaries/api-service \
            ubuntu@${{ secrets.AWS_HOST }}:/tmp/api-service

          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            ubuntu@${{ secrets.AWS_HOST }} << 'EOF'
              sudo mv /tmp/api-service /usr/local/bin/api-service-monorepo
              sudo chmod +x /usr/local/bin/api-service-monorepo
              sudo systemctl restart api-service-monorepo
            EOF

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            ubuntu@${{ secrets.AWS_HOST }} << 'EOF'
              echo "Checking service status..."
              sudo systemctl status web-service-monorepo --no-pager || true
              sudo systemctl status api-service-monorepo --no-pager || true
            EOF
